<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Create Revision Request</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Create Revision Request</h2>
            <a id="back-btn" href="#" class="btn btn-secondary">&larr; Back</a>
        </div>

        <div class="card">
            <div class="card-body">
                <form id="request-form">
                    <div class="mb-3">
                        <label for="info" class="form-label">Request Details</label>
                        <textarea
                            name="info"
                            id="info"
                            class="form-control"
                            rows="5"
                            required
                        ></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </form>

                <div id="status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const submissionId = params.get("submission_id");

        if (!submissionId) {
            document.getElementById("request-form").innerHTML = '<div class="alert alert-warning">Missing submission ID.</div>';
        } else {
            // Set the back button to return to request.html
            document.getElementById("back-btn").href = `requests.html?submission_id=${submissionId}`;

            document.getElementById("request-form").addEventListener("submit", async (e) => {
                e.preventDefault();

                const info = document.getElementById("info").value.trim();
                if (!info) {
                    document.getElementById("status").innerHTML = '<div class="alert alert-warning">Please fill in the request details.</div>';
                    return;
                }

                try {
                    const res = await API.request(`/submissions/reviewer/request`, {
                        method: "POST",
                        body: JSON.stringify({ submission_id: submissionId, info }),
                    });

                    if (res) {
                        document.getElementById("status").innerHTML = '<div class="alert alert-success">Revision request submitted successfully!</div>';
                        document.getElementById("info").value = ""; // clear form
                    } else {
                        throw new Error("Unknown error");
                    }
                } catch (err) {
                    console.error(err);
                    document.getElementById("status").innerHTML = '<div class="alert alert-danger">Failed to submit request.</div>';
                }
            });
        }
    </script>
</body>
</html>
