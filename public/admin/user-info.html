<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Edit User</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            .skeleton .form-control,
            .skeleton .form-select {
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div class="container py-5">
            <div class="mb-4">
                <a href="/admin/users.html" class="btn btn-secondary"
                    >&larr; Back to Users</a
                >
            </div>

            <div class="card">
                <div class="card-header">
                    <h4>Edit User</h4>
                </div>
                <div class="card-body">
                    <form id="edit-form" class="skeleton">
                        <!-- Hidden ID field -->
                        <input type="hidden" name="id" id="id" />

                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input
                                type="text"
                                name="name"
                                id="name"
                                class="form-control placeholder-glow"
                                placeholder="Loading..."
                                disabled
                            />
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input
                                type="email"
                                name="email"
                                id="email"
                                class="form-control placeholder-glow"
                                placeholder="Loading..."
                                disabled
                            />
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label"
                                >New Password</label
                            >
                            <input
                                type="password"
                                name="password"
                                id="password"
                                class="form-control"
                                placeholder="Leave empty to keep current"
                            />
                        </div>

                        <div class="mb-3">
                            <label for="role" class="form-label">Role</label>
                            <select
                                name="role"
                                id="role"
                                class="form-select placeholder-glow"
                                disabled
                            >
                                <option>Loading...</option>
                            </select>
                        </div>

                        <div
                            class="d-flex justify-content-between align-items-center"
                        >
                            <button
                                type="submit"
                                class="btn btn-primary"
                                disabled
                                id="submit-btn"
                            >
                                Save Changes
                            </button>

                            <button
                                type="button"
                                class="btn btn-danger"
                                id="delete-btn"
                                style="display: none"
                            >
                                Delete User
                            </button>
                        </div>
                    </form>

                    <div class="mt-3" id="status"></div>
                </div>
            </div>
        </div>

        <script src="/js/api.js"></script>
        <script>
            const params = new URLSearchParams(window.location.search);
            const userId = params.get("id");

            async function fetchUser() {
                if (!userId) {
                    document.getElementById("status").innerHTML =
                        '<div class="alert alert-warning">User ID is missing in the URL.</div>';
                    return;
                }

                const user = await API.request(`/admin/users/${userId}`);
                if (!user) {
                    document.getElementById("status").innerHTML =
                        '<div class="alert alert-danger">Failed to load user.</div>';
                    return;
                }

                // Populate fields
                document.getElementById("id").value = user.id;
                document.getElementById("name").value = user.name;
                document.getElementById("email").value = user.email;
                document.getElementById("role").value = user.role;

                // Enable form and remove skeleton
                const form = document.getElementById("edit-form");
                form.classList.remove("skeleton");
                form.querySelectorAll("input, select, button").forEach((el) => {
                    el.disabled = false;
                });

                // Replace role select
                const roleSelect = document.getElementById("role");
                roleSelect.innerHTML = `
                <option value="admin">Admin</option>
                <option value="reviewer">Reviewer</option>
                <option value="applicant">Applicant</option>
              `;
                roleSelect.value = user.role;

                // Show delete button
                document.getElementById("delete-btn").style.display =
                    "inline-block";
            }

            document
                .getElementById("edit-form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    if (!data.password) delete data.password;

                    const updated = await API.request(`/admin/users/${userId}`, {
                        method: "PUT",
                        body: JSON.stringify(data),
                    });

                    const statusEl = document.getElementById("status");
                    if (updated) {
                        statusEl.innerHTML =
                            '<div class="alert alert-success">User updated successfully!</div>';
                    } else {
                        statusEl.innerHTML =
                            '<div class="alert alert-danger">Failed to update user.</div>';
                    }
                });

            document
                .getElementById("delete-btn")
                .addEventListener("click", async () => {
                    const confirmed = confirm(
                        "Are you sure you want to delete this user?"
                    );
                    if (!confirmed) return;

                    const result = await API.request(`/users/${userId}`, {
                        method: "DELETE",
                    });

                    if (result) {
                        alert("User deleted.");
                        window.location.href = "/admin/users.html";
                    } else {
                        document.getElementById("status").innerHTML =
                            '<div class="alert alert-danger">Failed to delete user.</div>';
                    }
                });

            fetchUser();
        </script>
    </body>
</html>
